name: Auto Deploy Results

on:
  schedule:
    - cron: '0 14 * * *'  # æ¯æ—¥23:00 JST (14:00 UTC)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout automation repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Clone keiba-data-shared
        run: |
          git clone https://github.com/apol0510/keiba-data-shared.git

      - name: Clone nankan-analytics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/apol0510/nankan-analytics.git

      - name: Install dependencies
        run: npm install

      - name: Generate results
        run: npm run generate:results

      - name: Deploy to nankan-analytics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä»Šæ—¥ã®æ—¥ä»˜å–å¾—
          DATE=$(date +%Y-%m-%d)

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          if [ ! -f "output/archiveResults-$DATE.json" ]; then
            echo "âŒ çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # nankan-analyticsã«ç§»å‹•
          cd nankan-analytics/astro-site

          # Gitè¨­å®š
          git config user.email "noreply@anthropic.com"
          git config user.name "Claude Code"

          # æ—¢å­˜ã®archiveResults.jsonã‚’èª­ã¿è¾¼ã¿
          if [ -f "src/data/archiveResults.json" ]; then
            cp src/data/archiveResults.json /tmp/archiveResults-backup.json
          fi

          # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ï¼ˆNode.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè¡Œï¼‰
          node -e "
            const fs = require('fs');
            const path = require('path');

            const sourceFile = '../../output/archiveResults-$DATE.json';
            const targetFile = 'src/data/archiveResults.json';

            let existingData = {};
            if (fs.existsSync(targetFile)) {
              existingData = JSON.parse(fs.readFileSync(targetFile, 'utf-8'));
            }

            const newData = JSON.parse(fs.readFileSync(sourceFile, 'utf-8'));
            const [year, month, day] = '$DATE'.split('-');

            if (!existingData[year]) existingData[year] = {};
            if (!existingData[year][month]) existingData[year][month] = {};
            existingData[year][month][day] = newData[year][month][day];

            fs.writeFileSync(targetFile, JSON.stringify(existingData, null, 2));
            fs.copyFileSync(targetFile, 'public/data/archiveResults.json');

            console.log('âœ… ãƒãƒ¼ã‚¸å®Œäº†');
          "

          # Git add
          git add src/data/archiveResults.json public/data/archiveResults.json

          # Git commit
          git commit -m "ğŸ“Š çµæœãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ»$DATE

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

          # Git push
          git push origin main

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼Netlifyè‡ªå‹•ãƒ“ãƒ«ãƒ‰é–‹å§‹"

      - name: Notify success
        if: success()
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "âœ… $DATE ã®çµæœãƒ‡ãƒ¼ã‚¿ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: Notify failure
        if: failure()
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "âŒ $DATE ã®çµæœãƒ‡ãƒ¼ã‚¿ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
